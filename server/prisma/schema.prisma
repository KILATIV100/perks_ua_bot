generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum LocationStatus {
  active
  coming_soon
}

enum UserRole {
  USER
  ADMIN
  OWNER
}

enum ProductType {
  MENU
  MERCH
  BEANS
}

enum GameType {
  TIC_TAC_TOE
  PERKIE_JUMP
}

enum OpponentType {
  AI
  HUMAN
}

enum GameStatus {
  WAITING
  PLAYING
  FINISHED
}

model Location {
  id          String         @id @default(uuid())
  name        String
  lat         Float?
  long        Float?
  address     String?
  status      LocationStatus @default(active)
  canPreorder Boolean        @default(true)
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  orders      Order[]

  @@map("locations")
}

model User {
  id                String           @id @default(uuid())
  telegramId        String           @unique
  username          String?
  firstName         String?
  lastName          String?
  points            Int              @default(0)
  totalSpins        Int              @default(0)
  lastSpin          DateTime?
  /// Date string in Kyiv timezone (YYYY-MM-DD). Used to reset spin at 00:00 Kyiv time.
  lastSpinDate      String?
  role              UserRole         @default(USER)
  referredById      String?
  redemptionCodes   RedemptionCode[]
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
  orders            Order[]
  sessionsAsPlayer1 GameSession[]    @relation("Player1")
  sessionsAsPlayer2 GameSession[]    @relation("Player2")

  @@map("users")
}

model Product {
  id          String      @id @default(uuid())
  name        String
  description String?
  volume      String?
  price       Decimal     @db.Decimal(10, 2)
  category    String
  type        ProductType @default(MENU)
  imageUrl    String?
  isActive    Boolean     @default(true)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  orderItems  OrderItem[]

  @@map("products")
}

model GameSession {
  id           String       @id @default(uuid())
  /// Type of game played
  type         GameType     @default(TIC_TAC_TOE)
  player1Id    String
  player2Id    String?
  player1      User         @relation("Player1", fields: [player1Id], references: [id])
  player2      User?        @relation("Player2", fields: [player2Id], references: [id])
  /// Board state JSON for TIC_TAC_TOE, null for single-player games
  boardState   Json?
  status       GameStatus   @default(WAITING)
  winnerId     String?
  /// Who the player played against (only relevant for TIC_TAC_TOE)
  opponentType OpponentType?
  /// Final score for PERKIE_JUMP single-player sessions
  score        Int?
  /// SHA-256 hash for server-side score validation (PERKIE_JUMP)
  securityHash String?
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  @@map("game_sessions")
}

model RedemptionCode {
  id        String    @id @default(uuid())
  code      String    @unique
  userId    String
  user      User      @relation(fields: [userId], references: [id])
  createdAt DateTime  @default(now())
  expiresAt DateTime
  used      Boolean   @default(false)
  usedAt    DateTime?
  usedBy    String?

  @@map("redemption_codes")
}

model Order {
  id            String      @id @default(uuid())
  userId        String
  user          User        @relation(fields: [userId], references: [id])
  locationId    String
  location      Location    @relation(fields: [locationId], references: [id])
  status        String      @default("PENDING")
  totalPrice    Decimal     @db.Decimal(10, 2)
  paymentMethod String      @default("cash")
  pickupMinutes Int         @default(10)
  deliveryType  String      @default("pickup")
  shippingAddr  String?
  phone         String?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  items         OrderItem[]

  @@map("orders")
}

model OrderItem {
  id        String  @id @default(uuid())
  orderId   String
  order     Order   @relation(fields: [orderId], references: [id])
  productId String
  product   Product @relation(fields: [productId], references: [id])
  name      String
  quantity  Int
  price     Decimal @db.Decimal(10, 2)

  @@map("order_items")
}
