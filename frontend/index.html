<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>PerkUp</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --bg: #ffffff; --text: #000000; --hint: #999999;
      --btn: #8B5A2B; --btn-text: #ffffff; --bg2: #f5f5f5;
    }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: var(--bg2); color: var(--text); min-height: 100vh; padding-bottom: 70px; -webkit-tap-highlight-color: transparent; }
    .hidden { display: none !important; }
    /* Header */
    .header { position: sticky; top: 0; z-index: 10; background: var(--bg); padding: 12px 16px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 1px 3px rgba(0,0,0,.08); }
    .header h1 { font-size: 20px; font-weight: 700; }
    .balance { text-align: right; }
    .balance small { font-size: 11px; color: var(--hint); }
    .balance .pts { font-weight: 700; color: #FFB300; }
    /* Nav */
    .nav { position: fixed; bottom: 0; left: 0; right: 0; z-index: 20; background: var(--bg); border-top: 1px solid #eee; display: flex; justify-content: space-around; padding: 6px 0 env(safe-area-inset-bottom, 8px); }
    .nav button { background: none; border: none; display: flex; flex-direction: column; align-items: center; font-size: 10px; color: var(--hint); cursor: pointer; padding: 4px 0; }
    .nav button .icon { font-size: 22px; }
    .nav button.active { color: var(--btn); }
    /* Content */
    .content { padding: 16px; }
    /* Cards */
    .card { background: var(--bg); border-radius: 16px; padding: 16px; margin-bottom: 12px; box-shadow: 0 1px 3px rgba(0,0,0,.05); }
    .card h3 { font-weight: 600; }
    .card .sub { font-size: 13px; color: var(--hint); margin-top: 2px; }
    /* Button */
    .btn { display: inline-block; padding: 12px 24px; background: var(--btn); color: var(--btn-text); border: none; border-radius: 16px; font-weight: 600; font-size: 15px; cursor: pointer; transition: transform .1s; -webkit-appearance: none; }
    .btn:active { transform: scale(.97); }
    .btn:disabled { opacity: .5; cursor: default; }
    .btn-full { width: 100%; text-align: center; }
    .btn-sm { padding: 8px 16px; font-size: 13px; border-radius: 12px; }
    .btn-ghost { background: transparent; color: var(--btn); border: 1px solid var(--btn); }
    /* Category tabs */
    .cat-tabs { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 8px; margin-bottom: 12px; -webkit-overflow-scrolling: touch; }
    .cat-tabs::-webkit-scrollbar { display: none; }
    .cat-tab { flex-shrink: 0; padding: 8px 16px; border-radius: 12px; font-size: 13px; font-weight: 500; border: none; cursor: pointer; white-space: nowrap; background: var(--bg); color: var(--text); }
    .cat-tab.active { background: var(--btn); color: var(--btn-text); }
    /* Product row */
    .product { display: flex; align-items: center; gap: 12px; background: var(--bg); border-radius: 16px; padding: 12px; margin-bottom: 8px; }
    .product .thumb { width: 52px; height: 52px; border-radius: 12px; background: var(--bg2); display: flex; align-items: center; justify-content: center; font-size: 24px; flex-shrink: 0; }
    .product .info { flex: 1; min-width: 0; }
    .product .info .name { font-size: 14px; font-weight: 600; }
    .product .info .vol { font-weight: 400; color: var(--hint); margin-left: 4px; }
    .product .info .desc { font-size: 12px; color: var(--hint); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .product .info .price { font-weight: 700; font-size: 14px; color: var(--btn); margin-top: 2px; }
    .product .actions { display: flex; align-items: center; gap: 6px; flex-shrink: 0; }
    .qty-btn { width: 32px; height: 32px; border-radius: 50%; border: none; font-size: 18px; font-weight: 700; cursor: pointer; display: flex; align-items: center; justify-content: center; }
    .qty-btn.minus { background: rgba(0,0,0,.08); color: var(--text); }
    .qty-btn.plus { background: var(--btn); color: var(--btn-text); }
    .qty-btn.add { background: rgba(139,90,43,.12); color: var(--btn); width: auto; border-radius: 12px; padding: 8px 16px; font-size: 14px; }
    .qty-val { width: 24px; text-align: center; font-weight: 700; font-size: 14px; }
    /* Wheel */
    .wheel-wrap { display: flex; flex-direction: column; align-items: center; padding: 24px 0; }
    .wheel-container { position: relative; width: 280px; height: 280px; margin-bottom: 24px; }
    .wheel-pointer { position: absolute; top: -8px; left: 50%; transform: translateX(-50%); width: 0; height: 0; border-left: 14px solid transparent; border-right: 14px solid transparent; border-top: 24px solid var(--btn); z-index: 2; }
    .wheel { width: 100%; height: 100%; border-radius: 50%; border: 4px solid var(--btn); overflow: hidden; position: relative; box-shadow: 0 4px 20px rgba(0,0,0,.15); }
    .wheel.spinning { transition: transform 4s cubic-bezier(.17,.67,.12,.99); }
    .wheel-center { position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%); width: 56px; height: 56px; border-radius: 50%; background: var(--btn); display: flex; align-items: center; justify-content: center; font-size: 24px; z-index: 2; box-shadow: 0 2px 8px rgba(0,0,0,.2); }
    .result-popup { padding: 12px 24px; border-radius: 16px; background: #FFD700; text-align: center; margin-bottom: 16px; animation: bounce .6s ease; }
    .result-popup .big { font-size: 24px; font-weight: 700; color: #78350f; }
    @keyframes bounce { 0%,100%{ transform: translateY(0); } 50%{ transform: translateY(-10px); } }
    .error-box { padding: 10px; border-radius: 12px; text-align: center; font-size: 13px; background: #FEE2E2; color: #DC2626; margin-bottom: 12px; }
    .info-box { padding: 10px; border-radius: 12px; text-align: center; font-size: 13px; background: #E0F2FE; color: #1d4ed8; margin-bottom: 12px; }
    .rules { margin-top: 24px; background: var(--bg); border-radius: 12px; padding: 14px; max-width: 320px; width: 100%; }
    .rules h4 { font-weight: 600; margin-bottom: 6px; }
    .rules ul { list-style: none; font-size: 13px; color: var(--hint); }
    .rules li { margin-bottom: 3px; }
    .rules li::before { content: 'â€¢ '; }
    /* Referral */
    .ref-link { font-size: 12px; word-break: break-all; padding: 10px; border-radius: 12px; background: var(--bg2); color: var(--hint); margin-bottom: 10px; }
    /* Fun Zone */
    .game-btns { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 12px; }
    .game-btn { display: flex; align-items: center; gap: 6px; padding: 8px 12px; border-radius: 12px; font-size: 13px; font-weight: 500; border: none; cursor: pointer; background: var(--bg2); color: var(--text); }
    .game-btn.active { background: var(--btn); color: var(--btn-text); }
    /* Fullscreen overlay */
    .overlay { position: fixed; inset: 0; z-index: 50; background: var(--bg); display: flex; flex-direction: column; }
    .overlay-header { display: flex; align-items: center; justify-content: space-between; padding: 12px 16px; border-bottom: 1px solid #eee; }
    .overlay-body { flex: 1; overflow: auto; padding: 16px; }
    /* TicTacToe */
    .ttt-board { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; max-width: 288px; margin: 0 auto; }
    .ttt-cell { aspect-ratio: 1; border-radius: 12px; background: var(--bg); border: 2px solid rgba(0,0,0,.08); font-size: 28px; font-weight: 700; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: transform .1s; }
    .ttt-cell:active { transform: scale(.95); }
    .ttt-cell.win { background: rgba(139,90,43,.15); border-color: var(--btn); transform: scale(1.05); }
    .ttt-cell.X { color: #667eea; }
    .ttt-cell.O { color: #f59e0b; }
    .mode-btns { display: flex; gap: 10px; justify-content: center; margin-bottom: 16px; }
    .scores-bar { display: flex; justify-content: center; gap: 32px; margin-bottom: 12px; }
    .scores-bar .s { text-align: center; }
    .scores-bar .s small { font-size: 11px; color: var(--hint); }
    .scores-bar .s .num { font-size: 22px; font-weight: 700; }
    .status-line { text-align: center; font-size: 14px; font-weight: 500; margin-bottom: 12px; }
    /* Radio */
    .radio-wrap { display: flex; align-items: center; gap: 12px; margin-bottom: 12px; }
    .radio-play { width: 52px; height: 52px; border-radius: 50%; border: none; font-size: 22px; color: #fff; cursor: pointer; display: flex; align-items: center; justify-content: center; }
    .eq { display: flex; align-items: flex-end; gap: 2px; height: 20px; margin-top: 6px; }
    .eq-bar { width: 3px; border-radius: 2px; background: var(--btn); }
    @keyframes eqBar { 0%,100%{ height: 15%; } 25%{ height: 80%; } 50%{ height: 40%; } 75%{ height: 95%; } }
    .vol-row { display: flex; align-items: center; gap: 8px; }
    .vol-row input[type=range] { flex: 1; height: 6px; border-radius: 3px; -webkit-appearance: none; appearance: none; outline: none; }
    .vol-row input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; width: 16px; height: 16px; border-radius: 50%; background: var(--btn); cursor: pointer; }
    /* Checkout modal */
    .checkout-overlay { position: fixed; inset: 0; z-index: 50; background: rgba(0,0,0,.5); display: flex; align-items: flex-end; justify-content: center; }
    .checkout-sheet { width: 100%; max-width: 450px; background: var(--bg); border-radius: 24px 24px 0 0; padding: 24px; max-height: 85vh; overflow-y: auto; animation: slideUp .3s ease; }
    @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
    .checkout-sheet .row { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #eee; font-size: 14px; }
    .checkout-sheet .total-row { border: none; font-weight: 700; font-size: 16px; }
    .pickup-grid { display: grid; grid-template-columns: repeat(4,1fr); gap: 8px; }
    .pickup-btn { padding: 10px; border-radius: 12px; font-size: 13px; font-weight: 500; border: none; cursor: pointer; text-align: center; }
    .pickup-btn.active { background: var(--btn); color: var(--btn-text); }
    .pickup-btn:not(.active) { background: var(--bg2); color: var(--text); }
    .pay-option { width: 100%; padding: 12px; border-radius: 12px; display: flex; align-items: center; gap: 10px; border: 2px solid transparent; cursor: pointer; font-size: 14px; font-weight: 500; background: var(--bg2); margin-bottom: 8px; }
    .pay-option.selected { border-color: var(--btn); background: rgba(139,90,43,.08); }
    .pay-option.disabled { opacity: .5; cursor: default; }
    /* Floating cart button */
    .cart-float { position: fixed; bottom: 70px; left: 16px; right: 16px; z-index: 18; }
    .cart-float .btn { box-shadow: 0 4px 15px rgba(139,90,43,.3); }
    /* Loading spinner */
    .spinner { width: 32px; height: 32px; border: 3px solid var(--btn); border-top-color: transparent; border-radius: 50%; animation: spin .8s linear infinite; margin: 40px auto; }
    @keyframes spin { to { transform: rotate(360deg); } }
    /* Terms modal */
    .terms-overlay { position: fixed; inset: 0; z-index: 50; background: rgba(0,0,0,.5); display: flex; align-items: center; justify-content: center; padding: 16px; }
    .terms-box { background: var(--bg); border-radius: 16px; padding: 24px; max-width: 400px; width: 100%; }
    .terms-box h2 { font-size: 18px; font-weight: 700; margin-bottom: 12px; }
    .terms-box p { font-size: 14px; margin-bottom: 8px; }
    /* Banner */
    .banner { padding: 10px; border-radius: 12px; text-align: center; font-size: 13px; background: #FFF8E1; color: #92400e; margin-bottom: 12px; }
  </style>
</head>
<body>

<div class="header">
  <h1>PerkUp</h1>
  <div class="balance">
    <small>ĞœÑ–Ğ¹ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ</small><br>
    <span class="pts" id="balancePts">0 Ğ±Ğ°Ğ»Ñ–Ğ²</span>
  </div>
</div>

<!-- TAB: Locations -->
<div class="content tab-content" id="tab-locations"></div>

<!-- TAB: Menu -->
<div class="content tab-content hidden" id="tab-menu"></div>

<!-- TAB: Shop -->
<div class="content tab-content hidden" id="tab-shop"></div>

<!-- TAB: Games -->
<div class="content tab-content hidden" id="tab-games"></div>

<!-- TAB: Bonuses -->
<div class="content tab-content hidden" id="tab-bonuses"></div>

<!-- Nav -->
<nav class="nav">
  <button class="active" data-tab="locations"><span class="icon">ğŸ“</span><span>Ğ¢Ğ¾Ñ‡ĞºĞ¸</span></button>
  <button data-tab="menu"><span class="icon">â˜•</span><span>ĞœĞµĞ½Ñ</span></button>
  <button data-tab="shop"><span class="icon">ğŸ›’</span><span>Shop</span></button>
  <button data-tab="games"><span class="icon">ğŸ®</span><span>Fun Zone</span></button>
  <button data-tab="bonuses"><span class="icon">ğŸ</span><span>Ğ‘Ğ¾Ğ½ÑƒÑĞ¸</span></button>
</nav>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PerkUp v2.0 â€” Standalone Telegram Mini App
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

const API_URL = (function() {
  const p = new URLSearchParams(location.search);
  return (p.get('api') || window.__PERKUP_API_URL || 'https://backend-production-5ee9.up.railway.app').replace(/\/+$/, '');
})();
const BOT_USERNAME = 'perkup_ua_bot';
const TG = window.Telegram?.WebApp;

// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let appUser = null;
let locations = [];
let selectedLocation = null;
let products = [];
let cart = []; // [{product, quantity}]
let canSpin = true;
let nextSpinAt = null;
let activeTab = 'locations';
let activeCategory = null;

// TG theme
const theme = (() => {
  const p = TG?.themeParams || {};
  return {
    bg: p.bg_color || '#ffffff', text: p.text_color || '#000000',
    hint: p.hint_color || '#999999', btn: p.button_color || '#8B5A2B',
    btnText: p.button_text_color || '#ffffff', bg2: p.secondary_bg_color || '#f5f5f5',
  };
})();

// Apply theme to CSS vars
document.documentElement.style.setProperty('--bg', theme.bg);
document.documentElement.style.setProperty('--text', theme.text);
document.documentElement.style.setProperty('--hint', theme.hint);
document.documentElement.style.setProperty('--btn', theme.btn);
document.documentElement.style.setProperty('--btn-text', theme.btnText);
document.documentElement.style.setProperty('--bg2', theme.bg2);

// TG user
const telegramUser = (() => {
  const u = TG?.initDataUnsafe?.user;
  if (u) return { id: u.id, firstName: u.first_name, username: u.username };
  const p = new URLSearchParams(location.search);
  const id = p.get('telegramId');
  if (id) return { id: Number(id), firstName: p.get('firstName') || 'Guest', username: p.get('username') || undefined };
  return null;
})();

const startParam = TG?.initDataUnsafe?.start_param || '';
const referralId = startParam.startsWith('ref_') ? startParam.replace('ref_', '') : null;

// â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
TG?.ready(); TG?.expand();

(async () => {
  await Promise.all([syncUser(), fetchLocations()]);
  setupNav();
  renderTab();
})();

// â”€â”€ API helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function api(method, path, body) {
  const opts = { method, headers: { 'Content-Type': 'application/json' } };
  if (body) opts.body = JSON.stringify(body);
  const res = await fetch(API_URL + path, opts);
  return res.json();
}

async function syncUser() {
  if (!telegramUser) return;
  try {
    const d = await api('POST', '/api/user/sync', {
      telegramId: String(telegramUser.id),
      username: telegramUser.username,
      firstName: telegramUser.firstName,
      referrerId: referralId || undefined,
    });
    appUser = d.user;
    checkSpinAvailability(appUser?.lastSpinDate);
    updateBalance();
  } catch (e) { console.error(e); }
}

async function fetchLocations() {
  try {
    const d = await api('GET', '/api/locations');
    locations = d.locations || [];
  } catch (e) { console.error(e); }
}

async function fetchProducts() {
  try {
    const d = await api('GET', '/api/products');
    products = d.products || [];
  } catch (e) { console.error(e); products = []; }
}

// â”€â”€ Spin helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getKyivDate(d) { return (d || new Date()).toLocaleDateString('en-CA', { timeZone: 'Europe/Kyiv' }); }

function checkSpinAvailability(lastSpinDate) {
  if (lastSpinDate === getKyivDate()) { canSpin = false; } else { canSpin = true; }
}

function updateBalance() {
  document.getElementById('balancePts').textContent = (appUser?.points || 0) + ' Ğ±Ğ°Ğ»Ñ–Ğ²';
}

// â”€â”€ Nav â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setupNav() {
  document.querySelectorAll('.nav button').forEach(btn => {
    btn.addEventListener('click', () => {
      activeTab = btn.dataset.tab;
      document.querySelectorAll('.nav button').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      renderTab();
    });
  });
}

function renderTab() {
  document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
  const el = document.getElementById('tab-' + activeTab);
  if (el) { el.classList.remove('hidden'); }
  if (activeTab === 'locations') renderLocations();
  else if (activeTab === 'menu') renderMenu('menu');
  else if (activeTab === 'shop') renderMenu('shop');
  else if (activeTab === 'games') renderGames();
  else if (activeTab === 'bonuses') renderBonuses();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• LOCATIONS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderLocations() {
  const el = document.getElementById('tab-locations');
  if (!locations.length) { el.innerHTML = '<div class="spinner"></div>'; return; }
  el.innerHTML = locations.map(loc => `
    <div class="card" style="cursor:pointer" onclick="selectLocation('${loc.id}')">
      <h3>${loc.name}</h3>
      <p class="sub">${loc.address || ''}</p>
    </div>
  `).join('');
}

function selectLocation(id) {
  selectedLocation = locations.find(l => l.id === id) || null;
  activeTab = 'menu';
  document.querySelectorAll('.nav button').forEach(b => b.classList.remove('active'));
  document.querySelector('.nav button[data-tab="menu"]')?.classList.add('active');
  renderTab();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• MENU / SHOP â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const CATEGORY_ICONS = { 'ĞšĞ°Ğ²Ğ°': 'â˜•', 'Ğ¥Ğ¾Ğ»Ğ¾Ğ´Ğ½Ñ– Ğ½Ğ°Ğ¿Ğ¾Ñ—': 'ğŸ§Š', 'ĞĞµ ĞºĞ°Ğ²Ğ°': 'ğŸµ', 'Ğ‡Ğ¶Ğ°': 'ğŸ”', 'ĞšĞ°Ğ²Ğ° Ğ½Ğ° Ğ¿Ñ€Ğ¾Ğ´Ğ°Ğ¶': 'ğŸ“¦', 'ĞœĞµÑ€Ñ‡': 'ğŸ‘•' };
const CATEGORY_ORDER = ['ĞšĞ°Ğ²Ğ°', 'Ğ¥Ğ¾Ğ»Ğ¾Ğ´Ğ½Ñ– Ğ½Ğ°Ğ¿Ğ¾Ñ—', 'ĞĞµ ĞºĞ°Ğ²Ğ°', 'Ğ‡Ğ¶Ğ°', 'ĞšĞ°Ğ²Ğ° Ğ½Ğ° Ğ¿Ñ€Ğ¾Ğ´Ğ°Ğ¶', 'ĞœĞµÑ€Ñ‡'];

async function renderMenu(mode) {
  const el = document.getElementById('tab-' + mode);
  if (!products.length) {
    el.innerHTML = '<div class="spinner"></div>';
    await fetchProducts();
  }

  const filtered = products.filter(p => mode === 'shop' ? (p.type === 'MERCH' || p.type === 'BEANS') : p.type === 'MENU');
  const cats = [...new Set(filtered.map(p => p.category))];
  const orderedCats = CATEGORY_ORDER.filter(c => cats.includes(c)).concat(cats.filter(c => !CATEGORY_ORDER.includes(c)));
  if (!activeCategory || !orderedCats.includes(activeCategory)) activeCategory = orderedCats[0] || null;

  const isViewOnly = mode === 'menu' && selectedLocation && (!selectedLocation.hasOrdering);
  const canOrder = mode === 'shop' || !isViewOnly;

  let html = '';
  if (isViewOnly) html += '<div class="banner">ğŸ“‹ Ğ¢Ñ–Ğ»ÑŒĞºĞ¸ Ğ´Ğ»Ñ Ğ¾Ğ·Ğ½Ğ°Ğ¹Ğ¾Ğ¼Ğ»ĞµĞ½Ğ½Ñ. Ğ—Ğ°Ğ¼Ğ¾Ğ²Ğ»ÑĞ¹Ñ‚Ğµ Ğ½Ğ° Ğ¼Ñ–ÑÑ†Ñ–!</div>';

  // Category tabs
  if (orderedCats.length > 1) {
    html += '<div class="cat-tabs">';
    orderedCats.forEach(c => {
      html += `<button class="cat-tab${activeCategory === c ? ' active' : ''}" onclick="setCategory('${c}','${mode}')">${CATEGORY_ICONS[c] || 'ğŸ“¦'} ${c}</button>`;
    });
    html += '</div>';
  }

  // Products
  const shown = activeCategory ? filtered.filter(p => p.category === activeCategory) : filtered;
  shown.forEach(p => {
    const qty = cartQty(p.id);
    const price = Number(p.price);
    html += `<div class="product">
      <div class="thumb">${CATEGORY_ICONS[p.category] || 'ğŸ“¦'}</div>
      <div class="info">
        <div class="name">${p.name}${p.volume ? `<span class="vol">${p.volume}</span>` : ''}</div>
        ${p.description ? `<div class="desc">${p.description}</div>` : ''}
        <div class="price">${price} Ğ³Ñ€Ğ½</div>
      </div>`;
    if (canOrder) {
      if (qty > 0) {
        html += `<div class="actions">
          <button class="qty-btn minus" onclick="changeCart('${p.id}',-1,'${mode}')">âˆ’</button>
          <span class="qty-val">${qty}</span>
          <button class="qty-btn plus" onclick="changeCart('${p.id}',1,'${mode}')">+</button>
        </div>`;
      } else {
        html += `<div class="actions"><button class="qty-btn add" onclick="changeCart('${p.id}',1,'${mode}')">+</button></div>`;
      }
    }
    html += '</div>';
  });

  if (!shown.length) html += `<p style="text-align:center;color:var(--hint);padding:40px 0">${mode === 'shop' ? 'ĞœĞ°Ğ³Ğ°Ğ·Ğ¸Ğ½ Ğ¿Ğ¾ĞºĞ¸ Ğ¿ÑƒÑÑ‚Ğ¸Ğ¹' : 'ĞœĞµĞ½Ñ Ğ¿Ğ¾ĞºĞ¸ Ğ¿ÑƒÑÑ‚Ğµ'}</p>`;
  el.innerHTML = html;

  // Cart float
  renderCartFloat(mode);
}

function setCategory(cat, mode) { activeCategory = cat; renderMenu(mode); }

function cartQty(pid) { return (cart.find(i => i.product.id === pid) || {}).quantity || 0; }

function changeCart(pid, delta, mode) {
  const existing = cart.find(i => i.product.id === pid);
  if (existing) {
    existing.quantity += delta;
    if (existing.quantity <= 0) cart = cart.filter(i => i.product.id !== pid);
  } else if (delta > 0) {
    const p = products.find(x => x.id === pid);
    if (p) cart.push({ product: p, quantity: 1 });
  }
  renderMenu(mode);
}

function renderCartFloat(mode) {
  let existing = document.getElementById('cart-float');
  if (existing) existing.remove();
  if (!cart.length || !telegramUser) return;
  const loc = mode === 'menu' ? selectedLocation : (selectedLocation || locations[0]);
  if (!loc) return;
  const total = cart.reduce((s, i) => s + Number(i.product.price) * i.quantity, 0);
  const div = document.createElement('div');
  div.id = 'cart-float'; div.className = 'cart-float';
  div.innerHTML = `<button class="btn btn-full" onclick="openCheckout()">ĞÑ„Ğ¾Ñ€Ğ¼Ğ¸Ñ‚Ğ¸ Ğ·Ğ°Ğ¼Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ â€” ${total} Ğ³Ñ€Ğ½</button>`;
  document.body.appendChild(div);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• CHECKOUT â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openCheckout() {
  const loc = activeTab === 'menu' ? selectedLocation : (selectedLocation || locations[0]);
  if (!loc || !cart.length || !telegramUser) return;
  const total = cart.reduce((s, i) => s + Number(i.product.price) * i.quantity, 0);

  const overlay = document.createElement('div');
  overlay.id = 'checkout-overlay'; overlay.className = 'checkout-overlay';
  overlay.innerHTML = `<div class="checkout-sheet">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
      <h2 style="font-size:18px;font-weight:700">ĞÑ„Ğ¾Ñ€Ğ¼Ğ»ĞµĞ½Ğ½Ñ Ğ·Ğ°Ğ¼Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ</h2>
      <button onclick="closeCheckout()" style="background:var(--bg2);border:none;width:32px;height:32px;border-radius:50%;cursor:pointer;color:var(--hint);font-size:18px">âœ•</button>
    </div>
    <div style="padding:10px;border-radius:12px;background:var(--bg2);margin-bottom:12px">
      <small style="color:var(--hint)">Ğ›Ğ¾ĞºĞ°Ñ†Ñ–Ñ</small><br><span style="font-weight:500;font-size:14px">ğŸ“ ${loc.name}</span>
    </div>
    <div style="margin-bottom:12px">
      <small style="color:var(--hint);font-weight:500">Ğ—Ğ°Ğ¼Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ</small>
      ${cart.map(i => `<div class="row"><span>${i.product.name} x${i.quantity}</span><span>${Number(i.product.price)*i.quantity} Ğ³Ñ€Ğ½</span></div>`).join('')}
      <div class="row total-row"><span>Ğ Ğ°Ğ·Ğ¾Ğ¼</span><span style="color:var(--btn)">${total} Ğ³Ñ€Ğ½</span></div>
    </div>
    <div style="margin-bottom:12px">
      <small style="color:var(--hint);font-weight:500">Ğ§Ğ°Ñ Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ğ½Ğ¾ÑÑ‚Ñ–</small>
      <div class="pickup-grid" style="margin-top:6px">
        ${[5,10,15,20].map(t => `<button class="pickup-btn${t===10?' active':''}" onclick="pickTime(this,${t})">${t} Ñ…Ğ²</button>`).join('')}
      </div>
    </div>
    <div style="margin-bottom:16px">
      <small style="color:var(--hint);font-weight:500">Ğ¡Ğ¿Ğ¾ÑÑ–Ğ± Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ğ¸</small>
      <div style="margin-top:6px">
        <div class="pay-option selected" id="pay-cash" onclick="setPay('CASH')"><span style="font-size:20px">ğŸ’µ</span>ĞŸÑ€Ğ¸ Ğ¾Ñ‚Ñ€Ğ¸Ğ¼Ğ°Ğ½Ğ½Ñ–</div>
        <div class="pay-option disabled"><span style="font-size:20px">ğŸ’³</span>Telegram Pay <small style="color:var(--hint);margin-left:4px">ĞĞµĞ·Ğ°Ğ±Ğ°Ñ€Ğ¾Ğ¼</small></div>
      </div>
    </div>
    <div id="checkout-error" class="error-box hidden"></div>
    <button class="btn btn-full" id="checkout-submit" onclick="submitOrder()">Ğ—Ğ°Ğ¼Ğ¾Ğ²Ğ¸Ñ‚Ğ¸ â€” ${total} Ğ³Ñ€Ğ½</button>
  </div>`;
  document.body.appendChild(overlay);
  window._checkoutPickup = 10;
  window._checkoutPay = 'CASH';
}

function closeCheckout() { document.getElementById('checkout-overlay')?.remove(); }
function pickTime(btn, t) {
  window._checkoutPickup = t;
  btn.parentElement.querySelectorAll('.pickup-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
}
function setPay(m) { window._checkoutPay = m; }

async function submitOrder() {
  const btn = document.getElementById('checkout-submit');
  const errEl = document.getElementById('checkout-error');
  if (btn.disabled) return;
  btn.disabled = true; btn.textContent = 'ĞÑ„Ğ¾Ñ€Ğ¼Ğ»ÑÑ”Ğ¼Ğ¾...';
  errEl.classList.add('hidden');
  const loc = activeTab === 'menu' ? selectedLocation : (selectedLocation || locations[0]);
  try {
    await api('POST', '/api/orders', {
      telegramId: String(telegramUser.id),
      locationId: loc.id,
      paymentMethod: window._checkoutPay,
      pickupTime: window._checkoutPickup,
      items: cart.map(i => ({ productId: i.product.id, quantity: i.quantity, price: Number(i.product.price) })),
    });
    cart = [];
    closeCheckout();
    renderTab();
  } catch (e) {
    errEl.textContent = 'ĞĞµ Ğ²Ğ´Ğ°Ğ»Ğ¾ÑÑ ÑÑ‚Ğ²Ğ¾Ñ€Ğ¸Ñ‚Ğ¸ Ğ·Ğ°Ğ¼Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ. Ğ¡Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹Ñ‚Ğµ Ğ¿Ñ–Ğ·Ğ½Ñ–ÑˆĞµ.';
    errEl.classList.remove('hidden');
    btn.disabled = false; btn.textContent = 'Ğ—Ğ°Ğ¼Ğ¾Ğ²Ğ¸Ñ‚Ğ¸';
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• BONUSES (Wheel + Referral) â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderBonuses() {
  const el = document.getElementById('tab-bonuses');
  const refLink = telegramUser ? `https://t.me/${BOT_USERNAME}?start=ref_${telegramUser.id}` : '';
  const devMode = new URLSearchParams(location.search).get('dev') === 'true';

  el.innerHTML = `
    <div class="wheel-wrap">
      <div class="wheel-container">
        <div class="wheel-pointer"></div>
        <div class="wheel" id="wheel" style="transform:rotate(0deg)">
          <canvas id="wheelCanvas" width="280" height="280"></canvas>
          <div class="wheel-center">ğŸ°</div>
        </div>
      </div>
      <div id="spin-result" class="hidden"></div>
      <div id="spin-error" class="hidden"></div>
      ${devMode ? '<div class="info-box">ğŸ›  Dev Mode: Ğ³ĞµĞ¾Ğ»Ğ¾ĞºĞ°Ñ†Ñ–Ñ Ğ²Ğ¸Ğ¼ĞºĞ½ĞµĞ½Ğ°</div>' : ''}
      <button class="btn" id="spin-btn" onclick="handleSpin()" ${!canSpin ? 'disabled' : ''}>${canSpin ? 'ğŸ¯ ĞšÑ€ÑƒÑ‚Ğ¸Ñ‚Ğ¸!' : 'ĞÑ‡Ñ–ĞºÑƒĞ¹Ñ‚Ğµ'}</button>
      ${!canSpin ? `<p style="text-align:center;color:var(--hint);margin-top:12px;font-size:13px">ğŸ¡ Ğ’Ğ¸ Ğ²Ğ¶Ğµ ĞºÑ€ÑƒÑ‚Ğ¸Ğ»Ğ¸ ĞºĞ¾Ğ»ĞµÑĞ¾ ÑÑŒĞ¾Ğ³Ğ¾Ğ´Ğ½Ñ–. Ğ¡Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹Ñ‚Ğµ Ğ·Ğ°Ğ²Ñ‚Ñ€Ğ°!</p>` : ''}
      <div class="rules">
        <h4>ğŸ“ ĞŸÑ€Ğ°Ğ²Ğ¸Ğ»Ğ° Ğ³Ñ€Ğ¸:</h4>
        <ul>
          <li>ĞšÑ€ÑƒÑ‚Ñ–Ñ‚ÑŒ ĞºĞ¾Ğ»ĞµÑĞ¾ Ñ€Ğ°Ğ· Ğ½Ğ° Ğ´Ğ¾Ğ±Ñƒ</li>
          <li>Ğ’Ğ¸Ğ³Ñ€Ğ°Ğ¹Ñ‚Ğµ 5, 10 Ğ°Ğ±Ğ¾ 15 Ğ±Ğ°Ğ»Ñ–Ğ²</li>
          ${!devMode ? '<li><strong>Ğ‘ÑƒĞ´ÑŒÑ‚Ğµ Ğ¿Ğ¾Ñ€ÑƒÑ‡ Ğ· ĞºĞ°Ğ²\'ÑÑ€Ğ½ĞµÑ</strong> (Ğ´Ğ¾ 100Ğ¼)</li>' : ''}
          <li>Ğ‘Ğ°Ğ»Ğ¸ Ğ¼Ğ¾Ğ¶Ğ½Ğ° Ğ¾Ğ±Ğ¼Ñ–Ğ½ÑÑ‚Ğ¸ Ğ½Ğ° Ğ·Ğ½Ğ¸Ğ¶ĞºĞ¸</li>
        </ul>
      </div>
    </div>
    <div class="card">
      <h3>ğŸ¤ Ğ ĞµÑ„ĞµÑ€Ğ°Ğ»ĞºĞ°</h3>
      <p class="sub" style="margin-bottom:10px">Ğ—Ğ°Ğ¿Ñ€Ğ¾ÑĞ¸ Ğ´Ñ€ÑƒĞ³Ğ° Ğ¹ Ğ¾Ñ‚Ñ€Ğ¸Ğ¼Ğ°Ğ¹ +10 Ğ±Ğ°Ğ»Ñ–Ğ² Ğ¿Ñ–ÑĞ»Ñ Ğ¹Ğ¾Ğ³Ğ¾ Ğ¿ĞµÑ€ÑˆĞ¾Ğ³Ğ¾ ÑĞ¿Ñ–Ğ½Ñƒ.</p>
      <div class="ref-link">${refLink || 'ĞŸĞ¾ÑĞ¸Ğ»Ğ°Ğ½Ğ½Ñ Ğ½ĞµĞ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğµ'}</div>
      <button class="btn btn-full btn-sm" onclick="copyRef()" ${!refLink ? 'disabled' : ''} id="copy-ref-btn">ğŸ“‹ ĞšĞ¾Ğ¿Ñ–ÑĞ²Ğ°Ñ‚Ğ¸ Ğ¿Ğ¾ÑĞ¸Ğ»Ğ°Ğ½Ğ½Ñ</button>
    </div>
    <p style="text-align:center;margin-top:12px"><button style="background:none;border:none;font-size:13px;color:var(--hint);text-decoration:underline;cursor:pointer" onclick="showTerms()">Ğ£Ğ¼Ğ¾Ğ²Ğ¸ Ğ²Ğ¸ĞºĞ¾Ñ€Ğ¸ÑÑ‚Ğ°Ğ½Ğ½Ñ</button></p>
  `;
  drawWheel();
}

function drawWheel() {
  const canvas = document.getElementById('wheelCanvas');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  const segments = [
    { value: 5, color: '#FFD700' }, { value: 10, color: '#FFA500' },
    { value: 15, color: '#FF6347' }, { value: 5, color: '#FFD700' },
    { value: 10, color: '#FFA500' }, { value: 15, color: '#FF6347' },
    { value: 5, color: '#FFD700' }, { value: 10, color: '#FFA500' },
  ];
  const cx = 140, cy = 140, r = 136, n = segments.length;
  segments.forEach((seg, i) => {
    const a1 = (2 * Math.PI / n) * i - Math.PI / 2;
    const a2 = a1 + 2 * Math.PI / n;
    ctx.beginPath(); ctx.moveTo(cx, cy); ctx.arc(cx, cy, r, a1, a2); ctx.closePath();
    ctx.fillStyle = seg.color; ctx.fill();
    ctx.save(); ctx.translate(cx, cy); ctx.rotate(a1 + Math.PI / n);
    ctx.fillStyle = '#fff'; ctx.font = 'bold 18px sans-serif'; ctx.textAlign = 'center';
    ctx.shadowColor = 'rgba(0,0,0,.4)'; ctx.shadowBlur = 2;
    ctx.fillText(String(seg.value), r * 0.6, 6);
    ctx.restore();
  });
}

let spinRotation = 0;
async function handleSpin() {
  if (!canSpin) return;
  const btn = document.getElementById('spin-btn');
  const errEl = document.getElementById('spin-error');
  const resEl = document.getElementById('spin-result');
  btn.disabled = true; btn.textContent = 'ğŸ“ Ğ’Ğ¸Ğ·Ğ½Ğ°Ñ‡Ğ°Ñ”Ğ¼Ğ¾...';
  errEl.classList.add('hidden'); resEl.classList.add('hidden');

  const devMode = new URLSearchParams(location.search).get('dev') === 'true';
  let lat, lng;

  if (!devMode) {
    try {
      const loc = await getLocation();
      lat = loc.lat; lng = loc.lng;
    } catch (e) {
      errEl.textContent = e.message || 'ĞĞµ Ğ²Ğ´Ğ°Ğ»Ğ¾ÑÑ Ğ¾Ñ‚Ñ€Ğ¸Ğ¼Ğ°Ñ‚Ğ¸ Ğ³ĞµĞ¾Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ñ–Ñ';
      errEl.className = 'error-box'; btn.disabled = false; btn.textContent = 'ğŸ¯ ĞšÑ€ÑƒÑ‚Ğ¸Ñ‚Ğ¸!';
      return;
    }
  }

  btn.textContent = 'ĞšÑ€ÑƒÑ‚Ğ¸Ñ‚ÑŒÑÑ...';
  const deg = 360 * 5 + Math.random() * 360;
  spinRotation += deg;
  const wheel = document.getElementById('wheel');
  wheel.classList.add('spinning');
  wheel.style.transform = `rotate(${spinRotation}deg)`;

  let result;
  try {
    result = await api('POST', '/api/user/spin', {
      telegramId: String(telegramUser.id), userLat: lat, userLng: lng,
      devMode,
    });
  } catch (e) { result = { error: 'NetworkError', message: 'ĞŸĞ¾Ğ¼Ğ¸Ğ»ĞºĞ° Ğ¼ĞµÑ€ĞµĞ¶Ñ–' }; }

  setTimeout(() => {
    wheel.classList.remove('spinning');
    if (result.reward !== undefined) {
      resEl.innerHTML = `<div class="result-popup"><span class="big">+${result.reward} Ğ±Ğ°Ğ»Ñ–Ğ²!</span></div>`;
      resEl.classList.remove('hidden');
      appUser = { ...appUser, points: result.newBalance };
      updateBalance();
      canSpin = false;
      btn.disabled = true; btn.textContent = 'ĞÑ‡Ñ–ĞºÑƒĞ¹Ñ‚Ğµ';
    } else {
      errEl.textContent = result.message || 'ĞŸĞ¾Ğ¼Ğ¸Ğ»ĞºĞ°';
      errEl.className = 'error-box';
    }
  }, 4000);
}

function getLocation() {
  return new Promise((resolve, reject) => {
    if (TG?.LocationManager) {
      TG.LocationManager.init(() => {
        if (TG.LocationManager.isInited && TG.LocationManager.isLocationAvailable) {
          TG.LocationManager.getLocation(loc => loc ? resolve({ lat: loc.latitude, lng: loc.longitude }) : reject(new Error('Ğ“ĞµĞ¾Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ñ–Ñ Ğ½ĞµĞ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ° Ñ‡ĞµÑ€ĞµĞ· Telegram')));
        } else { fallbackGeo(resolve, reject); }
      });
    } else { fallbackGeo(resolve, reject); }
  });
}

function fallbackGeo(resolve, reject) {
  if (!navigator.geolocation) return reject(new Error('Ğ‘Ñ€Ğ°ÑƒĞ·ĞµÑ€ Ğ½Ğµ Ğ¿Ñ–Ğ´Ñ‚Ñ€Ğ¸Ğ¼ÑƒÑ” Ğ³ĞµĞ¾Ğ»Ğ¾ĞºĞ°Ñ†Ñ–Ñ'));
  navigator.geolocation.getCurrentPosition(
    p => resolve({ lat: p.coords.latitude, lng: p.coords.longitude }),
    e => reject(new Error(e.code === 1 ? 'Ğ”Ğ¾ÑÑ‚ÑƒĞ¿ Ğ´Ğ¾ Ğ³ĞµĞ¾Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ñ–Ñ— Ğ·Ğ°Ğ±Ğ¾Ñ€Ğ¾Ğ½ĞµĞ½Ğ¾' : e.code === 2 ? 'GPS Ğ½ĞµĞ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¸Ğ¹' : 'Ğ§Ğ°Ñ Ğ¾Ñ‡Ñ–ĞºÑƒĞ²Ğ°Ğ½Ğ½Ñ Ğ²Ğ¸Ñ‡ĞµÑ€Ğ¿Ğ°Ğ½Ğ¾')),
    { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
  );
}

function copyRef() {
  const link = `https://t.me/${BOT_USERNAME}?start=ref_${telegramUser?.id}`;
  navigator.clipboard.writeText(link).then(() => {
    const btn = document.getElementById('copy-ref-btn');
    btn.textContent = 'âœ… Ğ¡ĞºĞ¾Ğ¿Ñ–Ğ¹Ğ¾Ğ²Ğ°Ğ½Ğ¾';
    setTimeout(() => btn.textContent = 'ğŸ“‹ ĞšĞ¾Ğ¿Ñ–ÑĞ²Ğ°Ñ‚Ğ¸ Ğ¿Ğ¾ÑĞ¸Ğ»Ğ°Ğ½Ğ½Ñ', 2000);
  }).catch(() => {});
}

function showTerms() {
  const d = document.createElement('div');
  d.className = 'terms-overlay'; d.id = 'terms-modal';
  d.innerHTML = `<div class="terms-box">
    <h2>ğŸ“œ Ğ£Ğ¼Ğ¾Ğ²Ğ¸ Ğ²Ğ¸ĞºĞ¾Ñ€Ğ¸ÑÑ‚Ğ°Ğ½Ğ½Ñ</h2>
    <p>1. ĞĞºÑ†Ñ–Ñ Ğ´Ñ–Ñ” Ğ² ÑƒÑÑ–Ñ… ĞºĞ°Ğ²'ÑÑ€Ğ½ÑÑ… PerkUp.</p>
    <p>2. 100 Ğ½Ğ°ĞºĞ¾Ğ¿Ğ¸Ñ‡ĞµĞ½Ğ¸Ñ… Ğ±Ğ°Ğ»Ñ–Ğ² Ğ¼Ğ¾Ğ¶Ğ½Ğ° Ğ¾Ğ±Ğ¼Ñ–Ğ½ÑÑ‚Ğ¸ Ğ½Ğ° Ğ±ÑƒĞ´ÑŒ-ÑĞºĞ¸Ğ¹ Ğ½Ğ°Ğ¿Ñ–Ğ¹.</p>
    <p>3. ĞšĞ¾Ğ´ Ğ½Ğ° Ğ¾Ñ‚Ñ€Ğ¸Ğ¼Ğ°Ğ½Ğ½Ñ Ğ½Ğ°Ğ¿Ğ¾Ñ Ğ´Ñ–Ğ¹ÑĞ½Ğ¸Ğ¹ Ğ¿Ñ€Ğ¾Ñ‚ÑĞ³Ğ¾Ğ¼ 15 Ñ…Ğ²Ğ¸Ğ»Ğ¸Ğ½ Ğ¿Ñ–ÑĞ»Ñ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ°Ñ†Ñ–Ñ—.</p>
    <p>4. Ğ‘Ğ°Ğ»Ğ¸ Ğ½Ğµ Ğ¿Ñ–Ğ´Ğ»ÑĞ³Ğ°ÑÑ‚ÑŒ Ğ¾Ğ±Ğ¼Ñ–Ğ½Ñƒ Ğ½Ğ° Ğ³Ñ€Ğ¾ÑˆĞ¾Ğ²Ğ¸Ğ¹ ĞµĞºĞ²Ñ–Ğ²Ğ°Ğ»ĞµĞ½Ñ‚.</p>
    <button class="btn btn-full" style="margin-top:16px" onclick="document.getElementById('terms-modal').remove()">Ğ—Ñ€Ğ¾Ğ·ÑƒĞ¼Ñ–Ğ»Ğ¾</button>
  </div>`;
  document.body.appendChild(d);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• GAMES â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let currentGame = 'tic_tac_toe';

function renderGames() {
  const el = document.getElementById('tab-games');
  el.innerHTML = `
    <div class="card">
      <h2 style="font-size:20px;font-weight:700;margin-bottom:4px">ğŸ® Fun Zone</h2>
      <p class="sub">ĞĞ±Ğ¸Ñ€Ğ°Ğ¹ Ğ³Ñ€Ñƒ Ğ°Ğ±Ğ¾ Ğ²Ğ¼Ğ¸ĞºĞ°Ğ¹ PerkUp Radio.</p>
      <div class="game-btns">
        <button class="game-btn${currentGame === 'tic_tac_toe' ? ' active' : ''}" onclick="openGame('tic_tac_toe')">âŒâ­• Ğ¥Ñ€ĞµÑÑ‚Ğ¸ĞºĞ¸-Ğ½ÑƒĞ»Ğ¸ĞºĞ¸</button>
        <button class="game-btn${currentGame === 'perky_jump' ? ' active' : ''}" onclick="openGame('perky_jump')">ğŸª‚ Perky Jump</button>
      </div>
    </div>
    <div class="card" id="radio-card"></div>
  `;
  renderRadio();
}

function openGame(id) {
  currentGame = id;
  if (id === 'tic_tac_toe') openTicTacToe();
  else if (id === 'perky_jump') openPerkyJump();
}

// â”€â”€ Tic-Tac-Toe â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let tttBoard, tttTurn, tttResult, tttScores, tttMode, tttAiThinking;

function openTicTacToe() {
  tttBoard = Array(9).fill(null); tttTurn = 'X'; tttResult = null;
  tttScores = { p1: 0, p2: 0, draws: 0 }; tttMode = 'pve'; tttAiThinking = false;

  const overlay = document.createElement('div');
  overlay.className = 'overlay'; overlay.id = 'game-overlay';
  overlay.innerHTML = `
    <div class="overlay-header">
      <span style="font-weight:600">Ğ¥Ñ€ĞµÑÑ‚Ğ¸ĞºĞ¸-ĞÑƒĞ»Ğ¸ĞºĞ¸</span>
      <button class="btn btn-sm btn-ghost" onclick="document.getElementById('game-overlay').remove()">Ğ—Ğ°ĞºÑ€Ğ¸Ñ‚Ğ¸</button>
    </div>
    <div class="overlay-body" id="ttt-body"></div>
  `;
  document.body.appendChild(overlay);
  renderTTT();
}

function renderTTT() {
  const el = document.getElementById('ttt-body');
  if (!el) return;
  const p2 = tttMode === 'pve' ? 'ĞŸĞµÑ€ĞºÑ–' : 'Ğ“Ñ€Ğ°Ğ²ĞµÑ†ÑŒ 2';
  let status = '';
  if (tttResult === 'draw') status = 'ĞÑ–Ñ‡Ğ¸Ñ! ğŸ¤';
  else if (tttResult) status = tttMode === 'pve' ? (tttResult === 'X' ? 'Ğ¢Ğ¸ Ğ¿ĞµÑ€ĞµĞ¼Ñ–Ğ³! ğŸ‰' : 'ĞŸĞµÑ€ĞºÑ– Ğ¿ĞµÑ€ĞµĞ¼Ñ–Ğ³! ğŸ¤–â˜•') : `${tttResult === 'X' ? 'Ğ“Ñ€Ğ°Ğ²ĞµÑ†ÑŒ 1' : 'Ğ“Ñ€Ğ°Ğ²ĞµÑ†ÑŒ 2'} Ğ¿ĞµÑ€ĞµĞ¼Ñ–Ğ³! ğŸ‰`;
  else if (tttAiThinking) status = 'ĞŸĞµÑ€ĞºÑ– Ğ´ÑƒĞ¼Ğ°Ñ”...â˜•';
  else if (tttMode === 'pve') status = 'Ğ¢Ğ²Ñ–Ğ¹ Ñ…Ñ–Ğ´ (X)';
  else status = `${tttTurn === 'X' ? 'Ğ“Ñ€Ğ°Ğ²ĞµÑ†ÑŒ 1' : 'Ğ“Ñ€Ğ°Ğ²ĞµÑ†ÑŒ 2'} (${tttTurn}) Ñ…Ğ¾Ğ´Ğ¸Ñ‚ÑŒ`;

  const winLine = tttGetWinLine();

  el.innerHTML = `
    <div style="text-align:center;margin-bottom:12px">
      <div class="mode-btns">
        <button class="btn btn-sm ${tttMode==='pve'?'':'btn-ghost'}" onclick="tttSetMode('pve')">ğŸ¤– vs ĞŸĞµÑ€ĞºÑ–</button>
        <button class="btn btn-sm ${tttMode==='pvp'?'':'btn-ghost'}" onclick="tttSetMode('pvp')">ğŸ® 2 Ğ³Ñ€Ğ°Ğ²Ñ†Ñ–</button>
      </div>
    </div>
    <div style="background:var(--bg2);border-radius:16px;padding:16px">
      <div class="scores-bar">
        <div class="s"><small>${tttMode==='pve'?'Ğ¢Ğ¸':'Ğ“Ñ€Ğ°Ğ²ĞµÑ†ÑŒ 1'}</small><div class="num" style="color:#667eea">${tttScores.p1}</div></div>
        <div class="s"><small>ĞÑ–Ñ‡Ğ¸Ñ—</small><div class="num">${tttScores.draws}</div></div>
        <div class="s"><small>${p2}</small><div class="num" style="color:#f59e0b">${tttScores.p2}</div></div>
      </div>
      <div class="status-line" style="${tttResult ? 'color:var(--btn)' : ''}">${status}</div>
      <div class="ttt-board">
        ${tttBoard.map((c, i) => {
          const isWin = winLine && winLine.includes(i);
          return `<button class="ttt-cell${c ? ' ' + c : ''}${isWin ? ' win' : ''}" onclick="tttClick(${i})" ${tttResult || c || tttAiThinking || (tttMode==='pve' && tttTurn==='O') ? 'disabled' : ''}>${c || ''}</button>`;
        }).join('')}
      </div>
      <button class="btn btn-full" style="margin-top:16px" onclick="tttReset()">ĞĞ¾Ğ²Ğ° Ğ³Ñ€Ğ°</button>
    </div>
    ${tttMode === 'pve' ? '<p style="text-align:center;font-size:12px;color:var(--hint);margin-top:12px">â˜• ĞŸĞµÑ€ĞºÑ– Ğ²Ğ¸ĞºĞ¾Ñ€Ğ¸ÑÑ‚Ğ¾Ğ²ÑƒÑ” Ğ¼Ñ–Ğ½Ñ–Ğ¼Ğ°ĞºÑ â€” Ğ¿ĞµÑ€ĞµĞ¼Ğ¾Ğ³Ñ‚Ğ¸ Ğ½ĞµĞ¼Ğ¾Ğ¶Ğ»Ğ¸Ğ²Ğ¾!</p>' : ''}
  `;
}

const TTT_WINS = [[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];

function tttCheckWinner() {
  for (const [a,b,c] of TTT_WINS) { if (tttBoard[a] && tttBoard[a]===tttBoard[b] && tttBoard[a]===tttBoard[c]) return tttBoard[a]; }
  return null;
}
function tttGetWinLine() {
  for (const l of TTT_WINS) { const [a,b,c]=l; if (tttBoard[a] && tttBoard[a]===tttBoard[b] && tttBoard[a]===tttBoard[c]) return l; }
  return null;
}
function tttIsFull() { return tttBoard.every(c => c !== null); }

function tttMinimax(board, depth, isMax, alpha, beta) {
  const w = (() => { for (const [a,b,c] of TTT_WINS) { if (board[a] && board[a]===board[b] && board[a]===board[c]) return board[a]; } return null; })();
  if (w === 'O') return 10 - depth;
  if (w === 'X') return depth - 10;
  if (board.every(c => c !== null)) return 0;
  if (isMax) {
    let best = -Infinity;
    for (let i = 0; i < 9; i++) { if (!board[i]) { board[i]='O'; best=Math.max(best,tttMinimax(board,depth+1,false,alpha,beta)); board[i]=null; alpha=Math.max(alpha,best); if(beta<=alpha)break; } }
    return best;
  } else {
    let best = Infinity;
    for (let i = 0; i < 9; i++) { if (!board[i]) { board[i]='X'; best=Math.min(best,tttMinimax(board,depth+1,true,alpha,beta)); board[i]=null; beta=Math.min(beta,best); if(beta<=alpha)break; } }
    return best;
  }
}

function tttBestAiMove() {
  let best=-Infinity, move=-1;
  for (let i=0;i<9;i++) { if(!tttBoard[i]) { tttBoard[i]='O'; const s=tttMinimax(tttBoard,0,false,-Infinity,Infinity); tttBoard[i]=null; if(s>best){best=s;move=i;} } }
  return move;
}

function tttClick(i) {
  if (tttResult || tttBoard[i] || tttAiThinking) return;
  if (tttMode === 'pve' && tttTurn === 'O') return;
  tttBoard[i] = tttTurn;
  const w = tttCheckWinner();
  if (w) { tttResult = w; tttScores[w==='X'?'p1':'p2']++; }
  else if (tttIsFull()) { tttResult = 'draw'; tttScores.draws++; }
  else { tttTurn = tttTurn === 'X' ? 'O' : 'X'; if (tttMode === 'pve' && tttTurn === 'O') { tttAiThinking = true; renderTTT(); setTimeout(tttAiMove, 450); return; } }
  renderTTT();
}

function tttAiMove() {
  const move = tttBestAiMove();
  if (move < 0) { tttAiThinking = false; renderTTT(); return; }
  tttBoard[move] = 'O';
  const w = tttCheckWinner();
  if (w) { tttResult = w; tttScores.p2++; }
  else if (tttIsFull()) { tttResult = 'draw'; tttScores.draws++; }
  else { tttTurn = 'X'; }
  tttAiThinking = false;
  renderTTT();
}

function tttReset() { tttBoard = Array(9).fill(null); tttTurn = 'X'; tttResult = null; tttAiThinking = false; renderTTT(); }
function tttSetMode(m) { tttMode = m; tttReset(); }

// â”€â”€ Perky Jump â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openPerkyJump() {
  const overlay = document.createElement('div');
  overlay.className = 'overlay'; overlay.id = 'game-overlay';
  overlay.innerHTML = `
    <div class="overlay-header">
      <span style="font-weight:600">Perky Jump</span>
      <button class="btn btn-sm btn-ghost" onclick="document.getElementById('game-overlay').remove()">Ğ—Ğ°ĞºÑ€Ğ¸Ñ‚Ğ¸</button>
    </div>
    <div class="overlay-body" style="padding:0">
      <iframe src="https://perky.up.railway.app" style="width:100%;height:100%;border:0" allow="fullscreen" loading="lazy"></iframe>
    </div>
  `;
  document.body.appendChild(overlay);
}

// â”€â”€ Radio â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let radioAudio = null, radioPlaying = false, radioVol = 0.7;

function renderRadio() {
  const el = document.getElementById('radio-card');
  if (!el) return;
  el.innerHTML = `
    <h3 style="font-weight:600;margin-bottom:12px">ğŸ“» PerkUp Radio</h3>
    <div class="radio-wrap">
      <button class="radio-play" id="radio-play-btn" style="background:${radioPlaying ? '#EF4444' : 'var(--btn)'}" onclick="toggleRadio()">${radioPlaying ? 'â¸' : 'â–¶'}</button>
      <div style="flex:1">
        <div style="font-size:14px;font-weight:500">${radioPlaying ? 'Ğ—Ğ°Ñ€Ğ°Ğ· Ğ³Ñ€Ğ°Ñ”' : 'Ğ Ğ°Ğ´Ñ–Ğ¾ Ğ²Ğ¸Ğ¼ĞºĞ½ĞµĞ½Ğ¾'}</div>
        <div style="font-size:12px;color:var(--hint)">Skyrock Radio Stream</div>
        ${radioPlaying ? `<div class="eq">${Array.from({length:12},(_,i)=>`<div class="eq-bar" style="animation:eqBar ${.6+i%4*.15}s ease-in-out ${i*.08}s infinite;height:15%"></div>`).join('')}</div>` : ''}
      </div>
    </div>
    <div class="vol-row">
      <span style="font-size:13px;color:var(--hint)">ğŸ”ˆ</span>
      <input type="range" min="0" max="1" step="0.05" value="${radioVol}" oninput="setRadioVol(this.value)" style="background:linear-gradient(to right,var(--btn) ${radioVol*100}%,rgba(0,0,0,.1) ${radioVol*100}%)">
      <span style="font-size:13px;color:var(--hint)">ğŸ”Š</span>
    </div>
  `;
}

function toggleRadio() {
  if (!radioAudio) {
    radioAudio = new Audio('https://icecast.skyrock.net/s/natio_mp3_128k');
    radioAudio.volume = radioVol;
  }
  if (radioPlaying) { radioAudio.pause(); radioPlaying = false; }
  else { radioAudio.play().catch(() => { radioPlaying = false; }); radioPlaying = true; }
  renderRadio();
}

function setRadioVol(v) {
  radioVol = parseFloat(v);
  if (radioAudio) radioAudio.volume = radioVol;
}
</script>
</body>
</html>
